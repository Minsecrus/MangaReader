<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>截图</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* 鼠标样式变为十字 */
            cursor: crosshair;
        }

        /* 背景图 */
        .source {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-repeat: no-repeat;
        }

        /* 遮罩 */
        .mask {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* 预览区 */
        .preview {
            display: none;
            position: absolute;
            border: 1px dashed white;
        }

        /* 宽高 */
        .size {
            display: none;
            position: absolute;
            font-size: 14px;
            color: white;
            text-shadow: 0 0 10px #000;
            user-select: none;
        }

        /* 按钮 */
        .tool {
            display: none;
            position: absolute;

        }

        .btn {
            border-radius: 8px;
            padding: 4px;
            cursor: pointer;
        }

        .icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>

<body>
    <div class="source"></div>
    <div class="mask"></div>
    <canvas class="preview"></canvas>
    <div class="size"></div>
    <div class="tool">
        <button class="btn btn-confirm">
            <svg class="icon" t="1763300665546" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="1561" width="50" height="50">
                <path d="M384 785.67L97.83 499.5l60.34-60.34L384 664.99l439.16-439.16 60.34 60.34z" p-id="1562"></path>
            </svg>
        </button>
        <button class="btn btn-cancel">
            <svg class="icon" t="1763300712256" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="5811" width="50" height="50">
                <path
                    d="M97.1 91.2c11.3-11.3 29.8-11.3 41.1 0l782.2 782.2c11.3 11.3 11.3 29.8 0 41.1s-29.8 11.3-41.1 0L97.1 132.2c-11.3-11.3-11.3-29.7 0-41z"
                    fill="" p-id="5812"></path>
                <path
                    d="M920.4 91.1c11.3 11.3 11.3 29.8 0 41.1L138.2 914.5c-11.3 11.3-29.8 11.3-41.1 0s-11.3-29.8 0-41.1L879.3 91.1c11.4-11.3 29.8-11.3 41.1 0z"
                    fill="" p-id="5813"></path>
            </svg>
        </button>
    </div>

    <!-- <script src="./overlay.js"></script> -->
    <script>
        const $source = document.querySelector('.source')
        let sourceContext = null
        let scaleFactor = 1 // 默认缩放比例

        window.electronAPI.on('window:capture-source', (data) => {
            const { base64, scaleFactor: scale } = data
            scaleFactor = scale || 1 // 保存缩放比例
            $source.style.backgroundImage = `url(${base64})`

            const image = new Image()
            image.src = base64
            image.onload = () => {
                const canvas = document.createElement("canvas")
                canvas.width = image.width
                canvas.height = image.height
                // 添加 willReadFrequently 优化多次 getImageData 调用性能
                const context = canvas.getContext('2d', { willReadFrequently: true })
                context.drawImage(image, 0, 0)
                sourceContext = context
            }
        })

        const $preview = document.querySelector('.preview')
        const $size = document.querySelector('.size')
        const $tool = document.querySelector('.tool')
        const selection = {
            flag: false,
            x: 0,
            y: 0
        }

        document.addEventListener('mousedown', (event) => {
            const { x, y } = event
            selection.flag = true
            selection.x = x
            selection.y = y
        })

        document.addEventListener('mousemove', (event) => {
            if (!selection.flag || !sourceContext) {
                return
            }
            const { x, y } = event
            const left = Math.min(x, selection.x)
            const top = Math.min(y, selection.y)
            const width = Math.abs(x - selection.x)
            const height = Math.abs(y - selection.y)
            $preview.style.left = `${left}px`
            $preview.style.top = `${top}px`
            $preview.style.width = `${width}px`
            $preview.style.height = `${height}px`

            $preview.width = width * scaleFactor
            $preview.height = height * scaleFactor
            // 添加 willReadFrequently 优化性能
            const context = $preview.getContext('2d', { willReadFrequently: true })
            // 使用 scaleFactor 修正坐标,获取高分辨率图像的正确区域
            const imageData = sourceContext.getImageData(
                left * scaleFactor,
                top * scaleFactor,
                width * scaleFactor,
                height * scaleFactor
            )
            context.putImageData(imageData, 0, 0)
            $preview.style.display = 'block'

            $size.innerHTML = `${width}px x ${height}px`
            $size.style.left = `${left}px`
            $size.style.top = `${top}px`

            $size.style.display = 'block'

            $tool.style.left = `${left + width}px`
            $tool.style.top = `${top + height}px`
            $tool.style.display = 'block'
        })
        document.addEventListener('mouseup', () => {
            selection.flag = false
        })

        const btnCancel = document.querySelector('.btn-cancel')
        btnCancel.addEventListener('click', () => {
            window.electronAPI.send('window:capture-close')
        })

        const btnConfirm = document.querySelector('.btn-confirm')
        btnConfirm.addEventListener('click', () => {
            // 检查是否有选中的区域
            if ($preview.width > 0 && $preview.height > 0) {
                // 将 preview canvas 转换为 base64
                const screenshotData = $preview.toDataURL('image/png')
                // 发送截图数据到主进程
                window.electronAPI.send('window:capture-complete', screenshotData)
            }
        })
    </script>
</body>

</html>